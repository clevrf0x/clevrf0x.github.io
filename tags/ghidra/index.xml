<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ghidra on Favas M</title><link>https://favas.dev/tags/ghidra/</link><description>Recent content in Ghidra on Favas M</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sat, 05 Oct 2024 16:25:54 +0530</lastBuildDate><atom:link href="https://favas.dev/tags/ghidra/index.xml" rel="self" type="application/rss+xml"/><item><title>Simple Encryptor Walkthrough - HackTheBox</title><link>https://favas.dev/blogs/hackthebox/challenges/reversing/simple-encryptor/</link><pubDate>Sat, 05 Oct 2024 16:25:54 +0530</pubDate><guid>https://favas.dev/blogs/hackthebox/challenges/reversing/simple-encryptor/</guid><description>&lt;p>In this article, I’ll walk you through solving the &lt;strong>Simple Encryptor&lt;/strong> reversing challenge from the platform &lt;a href="https://hackthebox.eu">HackTheBox&lt;/a>. Since I haven’t done much in the realm of CTF or any kind of cybersecurity challenges for a while, my approach might not be perfect, and there may be some incorrect assumptions along the way. If you notice anything off, feel free to reach out, and I’ll be happy to correct it.&lt;/p>
&lt;p>Please keep in mind that I’m primarily a developer with no formal experience in reverse engineering or tools like &lt;code>Ghidra&lt;/code> or &lt;code>IDA Pro&lt;/code>, and my understanding of assembly is quite limited.&lt;/p></description><content>&lt;p>In this article, I’ll walk you through solving the &lt;strong>Simple Encryptor&lt;/strong> reversing challenge from the platform &lt;a href="https://hackthebox.eu">HackTheBox&lt;/a>. Since I haven’t done much in the realm of CTF or any kind of cybersecurity challenges for a while, my approach might not be perfect, and there may be some incorrect assumptions along the way. If you notice anything off, feel free to reach out, and I’ll be happy to correct it.&lt;/p>
&lt;p>Please keep in mind that I’m primarily a developer with no formal experience in reverse engineering or tools like &lt;code>Ghidra&lt;/code> or &lt;code>IDA Pro&lt;/code>, and my understanding of assembly is quite limited.&lt;/p>
&lt;h3 id="challenge-information">Challenge Information&lt;/h3>
&lt;p>Now that we&amp;rsquo;ve set the stage, let&amp;rsquo;s dive into the challenge itself. The description provided is as follows:&lt;/p>
&lt;blockquote>
&lt;p>During one of our routine checks on the secret flag storage server, we discovered it had been hit by ransomware! The original flag data is gone, but luckily, we still have both the encrypted file and the encryption program itself.&lt;/p>
&lt;/blockquote>
&lt;p>Next, let&amp;rsquo;s download the challenge files. There&amp;rsquo;s only one file, &lt;strong>Simple Encryptor.zip&lt;/strong>. After extracting it with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>unzip &lt;span style="color:#e6db74">&amp;#39;Simple Encryptor.zip&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We find a directory called &lt;strong>rev_simpleencryptor&lt;/strong>, containing two files: an encrypted flag file named &lt;em>flag.enc&lt;/em> and an executable binary named &lt;em>encrypt&lt;/em>.&lt;/p>
&lt;p>To start analyzing the binary, I decided to load it into GDB to get a better sense of what’s happening. I navigated to the &lt;strong>rev_simpleencryptor&lt;/strong> directory and opened the binary in GDB with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gdb encrypt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since GDB uses AT&amp;amp;T assembly syntax by default, I switched it to Intel format by running:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>set disassembly-flavor intel
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, I began the disassembly process with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>disass main
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here’s the initial output:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001289&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">endbr64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000128d&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">push&lt;/span> &lt;span style="color:#66d9ef">rbp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000128e&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rbp&lt;/span>,&lt;span style="color:#66d9ef">rsp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001291&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">sub&lt;/span> &lt;span style="color:#66d9ef">rsp&lt;/span>,&lt;span style="color:#ae81ff">0x40&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001295&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">12&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> &lt;span style="color:#66d9ef">fs&lt;/span>:&lt;span style="color:#ae81ff">0x28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000129e&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">21&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x8&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012a2&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">25&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">xor&lt;/span> &lt;span style="color:#66d9ef">eax&lt;/span>,&lt;span style="color:#66d9ef">eax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012a4&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">27&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">lea&lt;/span> &lt;span style="color:#66d9ef">rsi&lt;/span>,[&lt;span style="color:#66d9ef">rip&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">+&lt;/span>&lt;span style="color:#ae81ff">0xd59&lt;/span>] &lt;span style="color:#75715e"># 0x2004
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012ab&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">34&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">lea&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,[&lt;span style="color:#66d9ef">rip&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">+&lt;/span>&lt;span style="color:#ae81ff">0xd55&lt;/span>] &lt;span style="color:#75715e"># 0x2007
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012b2&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">41&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1170&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">fopen@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012b7&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">46&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012bb&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">50&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012bf&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">54&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">edx&lt;/span>,&lt;span style="color:#ae81ff">0x2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012c4&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">59&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">esi&lt;/span>,&lt;span style="color:#ae81ff">0x0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012c9&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">64&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012cc&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">67&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1160&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">fseek@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d1&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">72&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d5&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d8&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">79&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1130&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">ftell@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012dd&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">84&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x20&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012e1&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, if I’m being honest, I don’t have much experience with assembly, and I quickly realized that solving this challenge purely by reading the assembly code wasn’t going to work. However, if we look closely, we can spot a few familiar function calls like &lt;code>fopen&lt;/code>, &lt;code>fseek&lt;/code>, and &lt;code>ftell&lt;/code>. I recognized these functions from &lt;strong>&lt;code>libc&lt;/code>&lt;/strong>, the standard C library.&lt;/p>
&lt;p>Instead of trying to interpret the assembly line by line, I decided to go the decompilation route. While we can’t get the exact original source code from a binary, tools like &lt;code>Ghidra&lt;/code> and &lt;code>IDA Pro&lt;/code> can generate a fairly accurate approximation of the C code from the assembly.&lt;/p>
&lt;p>So, I installed &lt;code>Ghidra&lt;/code> on my machine, created a new project, and loaded the &lt;em>encrypt&lt;/em> binary. After some analysis, Ghidra produced a decompiled version of the binary, which looked like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>undefined8 &lt;span style="color:#a6e22e">main&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> iVar1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">time_t&lt;/span> tVar2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> in_FS_OFFSET;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint local_40;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint local_3c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> local_38;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>local_30;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">size_t&lt;/span> local_28;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>local_20;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>local_18;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> local_10;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_10 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_30 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_28 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_20 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(local_28);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(local_20,local_28,&lt;span style="color:#ae81ff">1&lt;/span>,local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tVar2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>((&lt;span style="color:#66d9ef">time_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#ae81ff">0x0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_40 &lt;span style="color:#f92672">=&lt;/span> (uint)tVar2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">srand&lt;/span>(local_40);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (local_38 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; local_38 &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">long&lt;/span>)local_28; local_38 &lt;span style="color:#f92672">=&lt;/span> local_38 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iVar1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">^&lt;/span> (byte)iVar1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> local_3c &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (sbyte)local_3c &lt;span style="color:#f92672">|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> (sbyte)local_3c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_18 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>local_40,&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">4&lt;/span>,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(local_20,&lt;span style="color:#ae81ff">1&lt;/span>,local_28,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (local_10 &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* WARNING: Subroutine does not return */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">__stack_chk_fail&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="code-explanation">Code Explanation&lt;/h3>
&lt;blockquote>
&lt;p>DISCLAIMER: I will be explaining the code in-depth, so if you already understand what&amp;rsquo;s going on, feel free to skip this section.&lt;/p>
&lt;/blockquote>
&lt;p>Let&amp;rsquo;s observe the decompiled code closely and try to rename variables and types based on context while trying to understand how this binary encrypts data. On the first line, we have &lt;code>undefined8 main(void)&lt;/code>, and at the end, we return &amp;lsquo;0&amp;rsquo;, which means &lt;code>undefined8&lt;/code> could be any kind of &lt;code>int&lt;/code> type. Let&amp;rsquo;s assume it is, in fact, &lt;code>int&lt;/code>. This is how we are trying to understand the decompiled code.&lt;/p>
&lt;p>Let&amp;rsquo;s explore what the code does:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> local_30 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_28 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_20 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(local_28);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(local_20,local_28,&lt;span style="color:#ae81ff">1&lt;/span>,local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this block, the application initially opens a file handler to the original file called &lt;code>flag&lt;/code> in read mode. Then, it moves the file pointer to the end of the file using the &lt;code>fseek()&lt;/code> function. The &lt;code>fseek()&lt;/code> function essentially accepts three arguments: a file pointer, an offset, and the position to which the file should move. The position can either be &lt;code>SEEK_SET&lt;/code> (which translates to 0), &lt;code>SEEK_CUR&lt;/code> (which translates to 1), or &lt;code>SEEK_END&lt;/code> (which translates to 2). The offset can be a positive or negative integer, meaning how many bytes we should deviate from the position. If we closely observe the code, we can see that here, the pointer is moved to the end of the file with a 0 offset, meaning no deviation, so we stay at the end of the file.&lt;/p>
&lt;p>Then, we call the &lt;code>ftell()&lt;/code> function, which accepts a file pointer and returns the current position as a &lt;code>size_t&lt;/code> or &lt;code>long&lt;/code>. These lines are used to calculate the file size. After that, the file pointer is moved back to the start of the file with a 0 offset by calling &lt;code>fseek(file_ptr, 0, 0)&lt;/code>. Next, we allocate some memory in the heap to store the file content and store the returned pointer in a variable. This can be seen as a temporary buffer. The application then reads the file content into the buffer by calling &lt;code>fread(buffer, file_size, number_of_chunks_to_read, file_ptr)&lt;/code>. Once all the contents are read into the buffer, it closes the file handle.&lt;/p>
&lt;p>So with this knowledge, we can convert our decompiled code into something more readable,&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>file_ptr &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(file_ptr, &lt;span style="color:#ae81ff">0&lt;/span>, SEEK_END);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> file_size &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(file_ptr);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(file_ptr, &lt;span style="color:#ae81ff">0&lt;/span>, SEEK_SET);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#f92672">*&lt;/span>buffer &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(file_size);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(buffer, file_size, &lt;span style="color:#ae81ff">1&lt;/span>, file_ptr);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(file_ptr);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, let&amp;rsquo;s move to the actual encryption part:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> tVar2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>((&lt;span style="color:#66d9ef">time_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#ae81ff">0x0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_40 &lt;span style="color:#f92672">=&lt;/span> (uint)tVar2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">srand&lt;/span>(local_40);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (local_38 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; local_38 &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">long&lt;/span>)local_28; local_38 &lt;span style="color:#f92672">=&lt;/span> local_38 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iVar1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">^&lt;/span> (byte)iVar1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> local_3c &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (sbyte)local_3c &lt;span style="color:#f92672">|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> (sbyte)local_3c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>First, we get the current time and store it in a variable, which we then convert to a &lt;code>uint&lt;/code>. This essentially gives us the number of seconds since the Unix epoch. We&amp;rsquo;re doing this to generate a unique seed value. But why do we need a unique seed value? Let&amp;rsquo;s dive into that first by understanding how random number generation (RNG) works on a computer. Despite the name, computers can’t truly generate random numbers. This means if we know the starting point (the seed), we can reproduce the same sequence of &amp;ldquo;random&amp;rdquo; numbers, making them not truly random. To fix this, we change the starting point to something unique that only we know—like the exact current time. That&amp;rsquo;s why the program generates a unique value based on the current time, down to the second, as the seed. Without this seed value, we wouldn&amp;rsquo;t be able to reproduce the same random numbers. Now that we understand RNG and the need for a unique seed, let&amp;rsquo;s continue.&lt;/p>
&lt;p>After getting the seed number, we call the &lt;code>srand()&lt;/code> function to seed the &lt;code>rand()&lt;/code> function. Then, we loop through every byte of the buffer and manipulate it to perform encryption. Let’s break down how the bytes are being manipulated. Inside the loop, we first generate a random value using &lt;code>rand()&lt;/code>. Then, we perform an &lt;code>XOR&lt;/code> operation on the byte. Luckily for us, &lt;code>XOR&lt;/code> operations can be reversed if we know the random number used for the &lt;code>XOR&lt;/code> by performing the same operation again.&lt;/p>
&lt;p>After that, we generate another random number using &lt;code>rand()&lt;/code> and perform a logical &lt;code>AND&lt;/code> operation with 7. This ensures that the number will always be between 0 and 7, regardless of the original value. Now that we have our random number, we perform a left shift operation on the byte using this number. Next, we perform a right shift operation on the same byte. We now have two versions of the byte (shifted in opposite directions). Finally, we combine these two values with a logical &lt;code>OR&lt;/code> operation and store the result as the final encrypted byte in the buffer. This is the most interesting and important part of the encryption process. We repeat this for every byte in the buffer, meaning we encrypt the entire file&amp;rsquo;s contents. The whole process can be reversed, assuming we know the initial seed value.&lt;/p>
&lt;p>Let’s rewrite that block of code in a more readable format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> current_time &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>(NULL);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint seed_number &lt;span style="color:#f92672">=&lt;/span> (uint)current_time;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">srand&lt;/span>(seed_number);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> file_size; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_xor &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> buffer[i] &lt;span style="color:#f92672">^&lt;/span> rand_num_xor;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rand_num_bitshift &lt;span style="color:#f92672">=&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> rand_num_bitshift) &lt;span style="color:#f92672">|&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> rand_num_bitshift);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Much better, right? Let&amp;rsquo;s move on to the next code block:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> local_18 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>local_40,&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">4&lt;/span>,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(local_20,&lt;span style="color:#ae81ff">1&lt;/span>,local_28,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_18);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It first opens a file handler to &lt;code>flag.enc&lt;/code> where the encrypted content will be written, using write byte mode. and since we are very lucky program writes the unique seed number as the first 4 bytes in the encrypted file along with encrypted buffer contents after that. Then closes the file handle since it is note need anymore. So let&amp;rsquo;s make this code a little bit readable too.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>encrypted_fp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>seed_number, &lt;span style="color:#ae81ff">1&lt;/span>, &lt;span style="color:#ae81ff">4&lt;/span>, encrypted_fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(buffer, &lt;span style="color:#ae81ff">1&lt;/span>, file_size, encrypted_fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(encrypted_fp);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Much more readable than our initial decompiled code, right? Now, let’s build an algorithm to reverse this process and retrieve the actual flag!&lt;/p>
&lt;h3 id="solution">Solution&lt;/h3>
&lt;p>Before diving into the code for the final solution, let&amp;rsquo;s first create an algorithm to reverse the encryption process to understand the flow.&lt;/p>
&lt;h4 id="algorithm">Algorithm&lt;/h4>
&lt;ol>
&lt;li>Open the encrypted file.&lt;/li>
&lt;li>Read the first 4 bytes as the seed value and store it in a variable for later use.&lt;/li>
&lt;li>Get the file size, subtracting 4 bytes (the size of the seed value), as we don&amp;rsquo;t need the seed in the encrypted data.&lt;/li>
&lt;li>Allocate a temporary buffer for storing the encrypted file content using &lt;code>malloc(file_size)&lt;/code>, and store the returned pointer in the buffer variable.&lt;/li>
&lt;li>Seed the &lt;code>rand()&lt;/code> function with &lt;code>srand(seed_value)&lt;/code>.&lt;/li>
&lt;li>Start a loop to decrypt the encrypted data.&lt;/li>
&lt;li>Generate two random values using &lt;code>rand()&lt;/code>: the first for reversing the &lt;code>XOR&lt;/code>, and the second for bit shifting.&lt;/li>
&lt;li>Perform bit shifting in reverse: first a right shift, then a left shift. After that, perform a logical OR operation and overwrite the buffer content at the current index.&lt;/li>
&lt;li>Finally, perform the &lt;code>XOR&lt;/code> operation again and overwrite the buffer content at the current index.&lt;/li>
&lt;li>Repeat this for all contents and print the buffer.&lt;/li>
&lt;/ol>
&lt;h4 id="code">Code&lt;/h4>
&lt;p>Now, let&amp;rsquo;s write the code. Since we were working with &lt;code>C&lt;/code> all this time, we&amp;rsquo;ll implement the solution in &lt;code>C&lt;/code> for consistency with the functions we&amp;rsquo;ve been using.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdint.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Open encrypted file
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE &lt;span style="color:#f92672">*&lt;/span>fp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Read seed value
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">uint32_t&lt;/span> seed;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>seed, &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed), &lt;span style="color:#ae81ff">1&lt;/span>, fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Get file_size - seed value size (4 bytes) and allocate memory
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">fseek&lt;/span>(fp, &lt;span style="color:#ae81ff">0&lt;/span>, SEEK_END);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> file_size &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(fp) &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint8_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>buffer &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(file_size);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Read encrypted file content to buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">fseek&lt;/span>(fp, &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed), SEEK_SET);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(buffer, &lt;span style="color:#ae81ff">1&lt;/span>, file_size, fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set seed value for rand()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">srand&lt;/span>(seed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> file_size; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// generate random numbers like encrypt binary
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_xor &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> shift_num &lt;span style="color:#f92672">=&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Reverse bit shifting and xor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> shift_num) &lt;span style="color:#f92672">|&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (&lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> shift_num));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> buffer[i] &lt;span style="color:#f92672">^&lt;/span> rand_num_xor;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Print result
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;%s&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, buffer);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">free&lt;/span>(buffer);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now let&amp;rsquo;s compile and run the solution code:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcc -o decrypt decrypt.c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./decrypt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This should print the flag in the format &lt;code>HTB{vRy*******************************0r}&lt;/code>.&lt;/p></content></item></channel></rss>