<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Walkthrough on Favas M</title><link>https://favas.dev/tags/walkthrough/</link><description>Recent content in Walkthrough on Favas M</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sat, 05 Oct 2024 16:25:54 +0530</lastBuildDate><atom:link href="https://favas.dev/tags/walkthrough/index.xml" rel="self" type="application/rss+xml"/><item><title>Simple Encryptor Walkthrough - HackTheBox</title><link>https://favas.dev/blogs/hackthebox/challenges/reversing/simple-encryptor/</link><pubDate>Sat, 05 Oct 2024 16:25:54 +0530</pubDate><guid>https://favas.dev/blogs/hackthebox/challenges/reversing/simple-encryptor/</guid><description>&lt;p>In this article, I’ll walk you through solving the &lt;strong>Simple Encryptor&lt;/strong> reversing challenge from the platform &lt;a href="https://hackthebox.eu">HackTheBox&lt;/a>. Since I haven’t done much in the realm of CTF or any kind of cybersecurity challenges for a while, my approach might not be perfect, and there may be some incorrect assumptions along the way. If you notice anything off, feel free to reach out, and I’ll be happy to correct it.&lt;/p>
&lt;p>Please keep in mind that I’m primarily a developer with no formal experience in reverse engineering or tools like &lt;code>Ghidra&lt;/code> or &lt;code>IDA Pro&lt;/code>, and my understanding of assembly is quite limited.&lt;/p></description><content>&lt;p>In this article, I’ll walk you through solving the &lt;strong>Simple Encryptor&lt;/strong> reversing challenge from the platform &lt;a href="https://hackthebox.eu">HackTheBox&lt;/a>. Since I haven’t done much in the realm of CTF or any kind of cybersecurity challenges for a while, my approach might not be perfect, and there may be some incorrect assumptions along the way. If you notice anything off, feel free to reach out, and I’ll be happy to correct it.&lt;/p>
&lt;p>Please keep in mind that I’m primarily a developer with no formal experience in reverse engineering or tools like &lt;code>Ghidra&lt;/code> or &lt;code>IDA Pro&lt;/code>, and my understanding of assembly is quite limited.&lt;/p>
&lt;h3 id="challenge-information">Challenge Information&lt;/h3>
&lt;p>Now that we&amp;rsquo;ve set the stage, let&amp;rsquo;s dive into the challenge itself. The description provided is as follows:&lt;/p>
&lt;blockquote>
&lt;p>During one of our routine checks on the secret flag storage server, we discovered it had been hit by ransomware! The original flag data is gone, but luckily, we still have both the encrypted file and the encryption program itself.&lt;/p>
&lt;/blockquote>
&lt;p>Next, let&amp;rsquo;s download the challenge files. There&amp;rsquo;s only one file, &lt;strong>Simple Encryptor.zip&lt;/strong>. After extracting it with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>unzip &lt;span style="color:#e6db74">&amp;#39;Simple Encryptor.zip&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We find a directory called &lt;strong>rev_simpleencryptor&lt;/strong>, containing two files: an encrypted flag file named &lt;em>flag.enc&lt;/em> and an executable binary named &lt;em>encrypt&lt;/em>.&lt;/p>
&lt;p>To start analyzing the binary, I decided to load it into GDB to get a better sense of what’s happening. I navigated to the &lt;strong>rev_simpleencryptor&lt;/strong> directory and opened the binary in GDB with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gdb encrypt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since GDB uses AT&amp;amp;T assembly syntax by default, I switched it to Intel format by running:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>set disassembly-flavor intel
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, I began the disassembly process with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>disass main
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here’s the initial output:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-asm" data-lang="asm">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001289&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">endbr64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000128d&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">push&lt;/span> &lt;span style="color:#66d9ef">rbp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000128e&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rbp&lt;/span>,&lt;span style="color:#66d9ef">rsp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001291&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">sub&lt;/span> &lt;span style="color:#66d9ef">rsp&lt;/span>,&lt;span style="color:#ae81ff">0x40&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x0000000000001295&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">12&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> &lt;span style="color:#66d9ef">fs&lt;/span>:&lt;span style="color:#ae81ff">0x28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x000000000000129e&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">21&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x8&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012a2&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">25&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">xor&lt;/span> &lt;span style="color:#66d9ef">eax&lt;/span>,&lt;span style="color:#66d9ef">eax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012a4&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">27&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">lea&lt;/span> &lt;span style="color:#66d9ef">rsi&lt;/span>,[&lt;span style="color:#66d9ef">rip&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">+&lt;/span>&lt;span style="color:#ae81ff">0xd59&lt;/span>] &lt;span style="color:#75715e"># 0x2004
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012ab&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">34&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">lea&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,[&lt;span style="color:#66d9ef">rip&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">+&lt;/span>&lt;span style="color:#ae81ff">0xd55&lt;/span>] &lt;span style="color:#75715e"># 0x2007
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012b2&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">41&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1170&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">fopen@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012b7&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">46&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012bb&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">50&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012bf&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">54&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">edx&lt;/span>,&lt;span style="color:#ae81ff">0x2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012c4&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">59&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">esi&lt;/span>,&lt;span style="color:#ae81ff">0x0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012c9&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">64&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012cc&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">67&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1160&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">fseek@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d1&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">72&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d5&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">76&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rdi&lt;/span>,&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012d8&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">79&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">call&lt;/span> &lt;span style="color:#ae81ff">0x1130&lt;/span> &amp;lt;&lt;span style="color:#66d9ef">ftell@plt&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012dd&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">84&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x20&lt;/span>],&lt;span style="color:#66d9ef">rax&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#960050;background-color:#1e0010">0&lt;/span>&lt;span style="color:#a6e22e">x00000000000012e1&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">&amp;lt;+&lt;/span>&lt;span style="color:#ae81ff">88&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;gt;&lt;/span>: &lt;span style="color:#66d9ef">mov&lt;/span> &lt;span style="color:#66d9ef">rax&lt;/span>,&lt;span style="color:#66d9ef">QWORD&lt;/span> &lt;span style="color:#66d9ef">PTR&lt;/span> [&lt;span style="color:#66d9ef">rbp-0x28&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, if I’m being honest, I don’t have much experience with assembly, and I quickly realized that solving this challenge purely by reading the assembly code wasn’t going to work. However, if we look closely, we can spot a few familiar function calls like &lt;code>fopen&lt;/code>, &lt;code>fseek&lt;/code>, and &lt;code>ftell&lt;/code>. I recognized these functions from &lt;strong>&lt;code>libc&lt;/code>&lt;/strong>, the standard C library.&lt;/p>
&lt;p>Instead of trying to interpret the assembly line by line, I decided to go the decompilation route. While we can’t get the exact original source code from a binary, tools like &lt;code>Ghidra&lt;/code> and &lt;code>IDA Pro&lt;/code> can generate a fairly accurate approximation of the C code from the assembly.&lt;/p>
&lt;p>So, I installed &lt;code>Ghidra&lt;/code> on my machine, created a new project, and loaded the &lt;em>encrypt&lt;/em> binary. After some analysis, Ghidra produced a decompiled version of the binary, which looked like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>undefined8 &lt;span style="color:#a6e22e">main&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> iVar1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">time_t&lt;/span> tVar2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> in_FS_OFFSET;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint local_40;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint local_3c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> local_38;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>local_30;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">size_t&lt;/span> local_28;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>local_20;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>local_18;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> local_10;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_10 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_30 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_28 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(local_30,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_20 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(local_28);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(local_20,local_28,&lt;span style="color:#ae81ff">1&lt;/span>,local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_30);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tVar2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>((&lt;span style="color:#66d9ef">time_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#ae81ff">0x0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_40 &lt;span style="color:#f92672">=&lt;/span> (uint)tVar2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">srand&lt;/span>(local_40);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (local_38 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; local_38 &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">long&lt;/span>)local_28; local_38 &lt;span style="color:#f92672">=&lt;/span> local_38 &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iVar1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">^&lt;/span> (byte)iVar1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_3c &lt;span style="color:#f92672">=&lt;/span> local_3c &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (sbyte)local_3c &lt;span style="color:#f92672">|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)local_20 &lt;span style="color:#f92672">+&lt;/span> local_38) &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> (sbyte)local_3c;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_18 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>local_40,&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">4&lt;/span>,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(local_20,&lt;span style="color:#ae81ff">1&lt;/span>,local_28,local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(local_18);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (local_10 &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* WARNING: Subroutine does not return */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">__stack_chk_fail&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="code-explanation">Code Explanation&lt;/h3>
&lt;blockquote>
&lt;p>DISCLAIMER: I will be explaining the code on a line-by-line basis, so if you already understand what&amp;rsquo;s going on, feel free to skip this section.&lt;/p>
&lt;/blockquote>
&lt;p>Let&amp;rsquo;s observe the decompiled code closely and try to rename variables and types based on context while trying to understand how this binary encrypts data. On the first line, we have &lt;code>undefined8 main(void)&lt;/code>, and at the end, we return &amp;lsquo;0&amp;rsquo;, which means &lt;code>undefined8&lt;/code> could be any kind of &lt;code>int&lt;/code> type. Let&amp;rsquo;s assume it is, in fact, &lt;code>int&lt;/code>. This is how we are trying to understand the decompiled code.&lt;/p>
&lt;p>If we look at line 17, we can see &lt;code>local_30 = fopen(&amp;quot;flag&amp;quot;,&amp;quot;rb&amp;quot;);&lt;/code>. Here, we are opening a file handler for our original file and assigning it to a variable called &lt;code>local_30&lt;/code>. Let&amp;rsquo;s rename it to &lt;code>original_file&lt;/code>.&lt;/p>
&lt;p>On the line below, we call &lt;code>fseek(original_file, 0, 2)&lt;/code>, which essentially translates to moving the cursor pointer to the end of our file. &lt;code>fseek()&lt;/code> accepts three arguments: the first is a file handler (our &lt;code>original_file&lt;/code>), the second is an offset value that specifies how many bytes we need to offset from the current position, and the third is the position to which we should move the cursor. So if we call &lt;code>fseek(file_handler_ptr, -5, 2)&lt;/code>, it will move the cursor 5 bytes backward from the end of the file. The position can be one of three values: 0, 1, or 2. Here, 0 means the beginning of the file (also known as the &lt;code>SEEK_SET&lt;/code> constant), 1 means the current cursor offset (where the cursor is currently pointing, also known as the &lt;code>SEEK_CUR&lt;/code> constant), and 2 means the end of the file (also known as the &lt;code>SEEK_END&lt;/code> constant).&lt;/p>
&lt;p>Now that we understand what that line is doing, we can look at the next one, where we see another &lt;code>libc&lt;/code> function being called. On line 19, we have &lt;code>ftell(original_file)&lt;/code>. This function returns a &lt;code>long int&lt;/code> representing the position of the file handler we passed. Since we moved the pointer to the end of the file with the previous &lt;code>fseek()&lt;/code> call, this will essentially return the size of the file. The returned file size is stored in the variable &lt;code>local_28&lt;/code>, so let&amp;rsquo;s rename it to &lt;code>file_size&lt;/code>.&lt;/p>
&lt;p>On the next line, we move the file pointer back to the beginning using &lt;code>fseek(original_file, 0, 0)&lt;/code>. As explained earlier, you now know what those numbers represent when passed as arguments to &lt;code>fseek()&lt;/code>.&lt;/p>
&lt;p>Next, we declare a new variable and call &lt;code>malloc(file_size)&lt;/code> to store the result. What we&amp;rsquo;re doing here is creating a temporary buffer with the same size as &lt;code>original_file&lt;/code>. The &lt;code>malloc()&lt;/code> function accepts a &lt;code>uint&lt;/code> value, allocates that amount of memory on the heap, and returns a pointer to it. So, we are essentially creating a memory block on the heap to hold the contents of the file. In that line, the result pointer is stored in a variable named &lt;code>local_20&lt;/code>, so let&amp;rsquo;s rename it to &lt;code>buffer&lt;/code>.&lt;/p>
&lt;p>In the next line, we perform a simple read operation where we read all the contents of &lt;code>original_file&lt;/code> and save them into our &lt;code>buffer&lt;/code> variable so we can manipulate the data later. After that, we close the &lt;code>original_file&lt;/code> handler since it’s no longer needed.&lt;/p>
&lt;p>Now, let&amp;rsquo;s move to the actual encryption part. We get the current time and store it in a variable named &lt;code>tVar2&lt;/code>, so let’s rename that variable to &lt;code>current_time&lt;/code>. We then typecast it to a &lt;code>uint&lt;/code> and store it in the variable &lt;code>local_40&lt;/code>, which represents how many seconds have passed since the Unix epoch. This will be our seed value for random number generation, so we can safely rename it to &lt;code>seed_number&lt;/code>.&lt;/p>
&lt;p>Now, let&amp;rsquo;s talk about why we need a seed value and how random number generation (RNG) works in computer science. Despite the name, computers can’t truly generate random numbers. Instead, they use algorithms to create numbers that appear random but can be reproduced if we use the same starting point—this is the seed value. By providing a unique value as the seed, we can generate a sequence of random numbers. To reproduce that sequence, we need the exact same seed. That&amp;rsquo;s why the binary generates a seed value. If we don&amp;rsquo;t know the exact time when this program was executed, we won&amp;rsquo;t be able to get the correct seed value.&lt;/p>
&lt;p>Now that we understand how random number generation and seed values work, let&amp;rsquo;s move on to the code. The code has a &lt;code>for&lt;/code> loop that will iterate over the buffer&amp;rsquo;s contents. We can rename the loop variable to &lt;code>i&lt;/code>, as is common practice.&lt;/p>
&lt;p>Inside the loop, we first generate a random number and store it in the variable &lt;code>iVar1&lt;/code>, which we can rename to &lt;code>rand_num_1&lt;/code>. Then, we perform a &lt;code>XOR&lt;/code> operation on the current buffer index and overwrite that position in the buffer with the new &lt;code>XOR&lt;/code>ed value. This operation essentially replaces the current buffer value with the result of the &lt;code>XOR&lt;/code>. In computer science, any value that has been &lt;code>XOR&lt;/code>ed can be reversed by performing the &lt;code>XOR&lt;/code> operation again using the same random number.&lt;/p>
&lt;p>Next, we generate another random number and store it in the variable &lt;code>local_3c&lt;/code>, which we’ll rename to &lt;code>rand_num_2&lt;/code>. Then, we perform a logical AND operation: &lt;code>rand_num_2 = rand_num_2 &amp;amp; 7&lt;/code>. A logical AND operation is used for bitwise manipulation, and in this case, it ensures that the result will always be a number between 0 and 7, no matter what the initial random value was.&lt;/p>
&lt;p>This is the most interesting part of the binary: we shift bits based on &lt;code>rand_num_2&lt;/code>. First, we left shift using the current random value, then we right shift it. We end up with two different values. After that, we perform a logical OR operation between these values and overwrite the current buffer index with the result of the OR operation. This code block is the core of the encryption process.&lt;/p>
&lt;p>The good thing is we can reverse this, assuming we have the initial random seed value generated using the current time. Now that the initial contents are encrypted, the code writes the seed value as the first 4 bytes of the encrypted file with the following code:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>encrypted_file &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>seed_number,&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">4&lt;/span>,encrypted_file);
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Lucky us, right? After writing the seed value to the encrypted file, the code then writes the encrypted data to the file handler. So, the first 4 bytes contain the seed value, followed by the encrypted content.&lt;/p>
&lt;p>Here’s the final processed &lt;code>C&lt;/code> code:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>(&lt;span style="color:#66d9ef">void&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">time_t&lt;/span> current_time;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> in_FS_OFFSET;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint seed_number;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uint rand_num_2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> i;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>original_file;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">size_t&lt;/span> file_size;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>buffer;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FILE &lt;span style="color:#f92672">*&lt;/span>encrypted_file;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> local_10;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_10 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> original_file &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(original_file,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">2&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> file_size &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(original_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fseek&lt;/span>(original_file,&lt;span style="color:#ae81ff">0&lt;/span>,&lt;span style="color:#ae81ff">0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(file_size);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(buffer,file_size,&lt;span style="color:#ae81ff">1&lt;/span>,original_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(original_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current_time &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">time&lt;/span>((&lt;span style="color:#66d9ef">time_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)&lt;span style="color:#ae81ff">0x0&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> seed_number &lt;span style="color:#f92672">=&lt;/span> (uint)current_time;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">srand&lt;/span>(seed_number);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> (&lt;span style="color:#66d9ef">long&lt;/span>)file_size; i &lt;span style="color:#f92672">=&lt;/span> i &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rand_num_1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)buffer &lt;span style="color:#f92672">+&lt;/span> i) &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)buffer &lt;span style="color:#f92672">+&lt;/span> i) &lt;span style="color:#f92672">^&lt;/span> (byte)rand_num_1;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rand_num_2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rand_num_2 &lt;span style="color:#f92672">=&lt;/span> rand_num_2 &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)buffer &lt;span style="color:#f92672">+&lt;/span> i) &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)buffer &lt;span style="color:#f92672">+&lt;/span> i) &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (sbyte)rand_num_2 &lt;span style="color:#f92672">|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>(byte &lt;span style="color:#f92672">*&lt;/span>)((&lt;span style="color:#66d9ef">long&lt;/span>)buffer &lt;span style="color:#f92672">+&lt;/span> i) &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> (sbyte)rand_num_2;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> encrypted_file &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>,&lt;span style="color:#e6db74">&amp;#34;wb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>seed_number,&lt;span style="color:#ae81ff">1&lt;/span>,&lt;span style="color:#ae81ff">4&lt;/span>,encrypted_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fwrite&lt;/span>(buffer,&lt;span style="color:#ae81ff">1&lt;/span>,file_size,encrypted_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(encrypted_file);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (local_10 &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">*&lt;/span>(&lt;span style="color:#66d9ef">long&lt;/span> &lt;span style="color:#f92672">*&lt;/span>)(in_FS_OFFSET &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x28&lt;/span>)) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* WARNING: Subroutine does not return */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">__stack_chk_fail&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Much more readable than our initial decompiled code, right? Now, let’s build an algorithm to reverse this process and retrieve the actual flag!&lt;/p>
&lt;p>Your explanation of the algorithm and the code is clear and concise. Here’s a slightly refined version with some minor tweaks for clarity and structure:&lt;/p>
&lt;h3 id="solution">Solution&lt;/h3>
&lt;p>Before diving into the code for the final solution, let&amp;rsquo;s first create an algorithm to reverse the encryption process to understand the flow.&lt;/p>
&lt;h4 id="algorithm">Algorithm&lt;/h4>
&lt;ol>
&lt;li>Open the encrypted file.&lt;/li>
&lt;li>Read the first 4 bytes as the seed value and store it in a variable for later use.&lt;/li>
&lt;li>Get the file size, subtracting 4 bytes (the size of the seed value), as we don&amp;rsquo;t need the seed in the encrypted data.&lt;/li>
&lt;li>Allocate a temporary buffer for storing the encrypted file content using &lt;code>malloc(file_size)&lt;/code>, and store the returned pointer in the buffer variable.&lt;/li>
&lt;li>Seed the &lt;code>rand()&lt;/code> function with &lt;code>srand(seed_value)&lt;/code>.&lt;/li>
&lt;li>Start a loop to decrypt the encrypted data.&lt;/li>
&lt;li>Generate two random values using &lt;code>rand()&lt;/code>: the first for reversing the &lt;code>XOR&lt;/code>, and the second for bit shifting.&lt;/li>
&lt;li>Perform bit shifting in reverse: first a right shift, then a left shift. After that, perform a logical OR operation and overwrite the buffer content at the current index.&lt;/li>
&lt;li>Finally, perform the &lt;code>XOR&lt;/code> operation again and overwrite the buffer content at the current index.&lt;/li>
&lt;li>Repeat this for all contents and print the buffer.&lt;/li>
&lt;/ol>
&lt;h4 id="code">Code&lt;/h4>
&lt;p>Now, let&amp;rsquo;s write the code. Since we were working with &lt;code>C&lt;/code> all this time, we&amp;rsquo;ll implement the solution in &lt;code>C&lt;/code> for consistency with the functions we&amp;rsquo;ve been using.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdint.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">int&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Open encrypted file
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> FILE &lt;span style="color:#f92672">*&lt;/span>fp &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">fopen&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;flag.enc&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;rb&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Read seed value
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">uint32_t&lt;/span> seed;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>seed, &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed), &lt;span style="color:#ae81ff">1&lt;/span>, fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Get file_size - seed value size (4 bytes) and allocate memory
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">fseek&lt;/span>(fp, &lt;span style="color:#ae81ff">0&lt;/span>, SEEK_END);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> file_size &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ftell&lt;/span>(fp) &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">uint8_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>buffer &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">malloc&lt;/span>(file_size);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Read encrypted file content to buffer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">fseek&lt;/span>(fp, &lt;span style="color:#66d9ef">sizeof&lt;/span>(seed), SEEK_SET);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fread&lt;/span>(buffer, &lt;span style="color:#ae81ff">1&lt;/span>, file_size, fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">fclose&lt;/span>(fp);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Set seed value for rand()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">srand&lt;/span>(seed);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> (&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>; i &lt;span style="color:#f92672">&amp;lt;&lt;/span> file_size; i&lt;span style="color:#f92672">++&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// generate random numbers like encrypt binary
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_xor &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">rand&lt;/span>();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> shift_num &lt;span style="color:#f92672">=&lt;/span> rand_num_bitshift &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Reverse bit shifting and xor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> shift_num) &lt;span style="color:#f92672">|&lt;/span> (buffer[i] &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> (&lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#f92672">-&lt;/span> shift_num));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buffer[i] &lt;span style="color:#f92672">=&lt;/span> buffer[i] &lt;span style="color:#f92672">^&lt;/span> rand_num_xor;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Print result
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;%s&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, buffer);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">free&lt;/span>(buffer);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now let&amp;rsquo;s compile and run the solution code:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcc -o decrypt decrypt.c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./decrypt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This should print the flag in the format &lt;code>HTB{vRy*******************************0r}&lt;/code>.&lt;/p></content></item></channel></rss>